@using WebApplicationNet5.Models
@{
    ViewBag.Title = "Home Page";
    Hospitals hp = new Hospitals();
    string hospitalinfo = hp.Load();
}

    
            
            <ul id="button">
                <li><a href="http://bedforecasting.azurewebsites.net/">Reload</a></li>
                <li><a href="http://140.128.135.12/ERFWeb">Map</a></li>
            </ul>

            <div class="main">

                <div id="abouttext">
                    <table cellspacing="0" cellpadding="5" border="0" style="background-color: transparent;">
                        <tr>
                            <td style="width:70%; vertical-align:top;">
                                為提高醫療網救護之品質及安全， 本系統考慮系統動態流程的觀念，快速地即時反應網絡內各醫院之病患相互轉院影響之動態病床使用資訊。網絡醫院病床預測資訊己考慮時間的概念，將可提高病床資訊的精準度，使病患到院後確切有病床的機率提高，也更有效率的資源分配規畫。本系統有以下特色：
                                <ul style="list-style-type:circle">
                                    <li>可預測及顯示醫院各類空床數量資訊在未來20, 40, 60分鐘等區間。</li>
                                    <li>提高資訊的精準度→醫院資訊考慮”時間”的概念，病患到院後確切有空床的機率提高。</li>
                                    <li>更有效率的資源規畫→若傷病情況超乎該院醫療資源或能力可以處置，則可盡早轉介至其他醫療院所或醫學中心，以節省時間。</li>
                                    <li>系統動態流程的觀念→快速地反應網絡內各醫院之病患相互轉院影響之空床數量資訊變化。</li>
                                </ul>


                                <p style="text-align:left;"> 累計瀏覽人數：<img src="http://counter1.fc2.com/counter_img.php?id=27501949&main=1" alt="odsm logo" /></p>

                            </td>
                            <td style="width:30%; background-color:#fff; text-align:left; vertical-align:bottom; color:#000;">
                                <img src="~/images/logo2.jpg" width="75%" alt="logo" /><br />
                                最佳決策系統研究團隊
                                <ul style="list-style-type:circle">
                                    <li>東海大學工業工程與經營資訊系 <a href="http://web.thu.edu.tw/sjweng/www/" target="_blank" style="color: #CC0000">翁紹仁</a>老師</li>
                                    <li>弘光科技大學資訊工程系 <a href="http://csie.hk.edu.tw/info/73" target="_blank" style="color: #CC0000">徐永煜</a>老師</li>
                                    <li>台中榮民總醫院嘉義分院 <a href="http://www.vhcy.gov.tw/vhcy/index.php?module=CurerInfo&action=user_detail&sn=693" target="_blank" style="color: #CC0000">王立敏</a>副院長（前中區緊急醫療應變中心執行長）</li>
                                </ul>

                            </td>

                        </tr>
                    </table>
                </div>

                <div id="css_table" style="width:100%">
                    <div class="css_tr">
                        <div class="css_td" style="text-align:left;vertical-align:bottom;width:50%;">
                            <h2>
                                請輸入救護車位置
                            </h2>

                            <p><input type="text" size="60" name="address" /><input type="submit" value="Go!" /></p>

                        </div>

                        <div class="css_td" style="text-align:left;vertical-align:bottom;width:50%;">
                            <div id="suggesttext" style="display: none;font-size: 1.5em; font-weight: 600;">建議醫院：</div>

                            <button type="button" id="Button0" style="display: none;" onclick='showinfoButtonclick(infowindow[0],hospMarker[0],event)'>台北榮民總醫院</button>
                            <button type="button" id="Button1" style="display: none;" onclick='showinfoButtonclick(infowindow[1],hospMarker[1],event)'>林口長庚醫院</button>
                            <button type="button" id="Button2" style="display: none;" onclick='showinfoButtonclick(infowindow[2],hospMarker[2],event)'>台中榮民總醫院</button>
                            <button type="button" id="Button3" style="display: none;" onclick='showinfoButtonclick(infowindow[3],hospMarker[3],event)'>台北市立萬芳醫院</button>
                            <button type="button" id="Button4" style="display: none;" onclick='showinfoButtonclick(infowindow[4],hospMarker[4],event)'>國立成功大學醫學院附設醫院</button>
                            <button type="button" id="Button5" style="display: none;" onclick='showinfoButtonclick(infowindow[5],hospMarker[5],event)'>花蓮慈濟醫院</button>
                            <button type="button" id="Button6" style="display: none;" onclick='showinfoButtonclick(infowindow[6],hospMarker[6],event)'>三軍總醫院附設民眾診療服務處</button>
                            <button type="button" id="Button7" style="display: none;" onclick='showinfoButtonclick(infowindow[7],hospMarker[7],event)'>秀傳紀念醫院</button>
                            <button type="button" id="Button8" style="display: none;" onclick='showinfoButtonclick(infowindow[8],hospMarker[8],event)'>彰化基督教醫院</button>
                            <button type="button" id="Button9" style="display: none;" onclick='showinfoButtonclick(infowindow[9],hospMarker[9],event)'>高雄榮民總醫院</button>
                            <button type="button" id="Button10" style="display: none;" onclick='showinfoButtonclick(infowindow[10],hospMarker[10],event)'>高雄醫學大學附設中和紀念醫院</button>
                            <button type="button" id="Button11" style="display: none;" onclick='showinfoButtonclick(infowindow[11],hospMarker[11],event)'>童綜合醫院</button>

                        </div>

                        <div class="css_td" style="text-align:right;vertical-align:bottom; top: 0px;">
                            <div id="test"></div>
                            <div style="vertical-align: middle; text-align: center">
                                <div style="margin: 0px; padding: 0px; top: 0px; clip: rect(0px, auto, auto, auto);">App Download</div>
                                <img src="~/images/APPQR.png" alt="QRCode" width="90" height="90" style="padding-bottom: 0px; margin-bottom: 0px" />

                            </div>

                        </div>

                    </div>

                </div>
                <div id="warnings_panel" style="background-color: #000; color:#7FFF00;font-size: 1.2em; font-weight: 400;">
                </div>
                <!-- This is the div that will contain the Google Map -->
                <div id="map_canvas" style="width: 100%; height: 500px"> </div>
            </div>
            <div class="clear">
            </div>


            <div class="footer">

            </div>
         




<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&language=zh-TW" type="text/javascript"></script>

<!-- This css is to ensure that the google map contols (zoom bar etc) show and size correctly. -->
<style>
    #map_canvas img {
        max-width: none;
    }
</style>

<!-- This css is to give a nice big popup "info window" when a marker is clicked on the map -->
<style>
    .infoDiv {
        height: 200px;
        width: 300px;
        -webkit-user-select: none;
        background-color: white;
    }
</style>


<!-- Enclose the Javascript in a "section" so that it is rendered in the correct order after scripts have been loaded etc -->
@section scripts {
    <section class="scripts">
        @Html.Raw(hospitalinfo)
        <script type="text/javascript">

    <!-- This code tells the browser to execute the "Initialize" method only when the complete document model has been loaded. -->
    $(document).ready(function () {
        Initialize();
    });

    // Where all the fun happens
        var currentLocMarker = null;

         var candlist = [];
         var hospDist = [];
         var lastShowMarker = null;
         var lastinfowindow = null;

         //var bestdist = [];
         var best1dist;
         //var bestidx = [];
         var Debug="";



         function showAddress(address) {

             if (geocoder) {
                 geocoder.geocode({ 'address': address }, function (results, status) {
                     if (status == google.maps.GeocoderStatus.OK) {

                         map.setCenter(results[0].geometry.location);
                         map.setZoom(10);
                         //map.panTo(results[0].geometry.location);

                         /*var marker = new google.maps.Marker({
                         map: map,
                         position: results[0].geometry.location
                         });*/

                         if (currentLocMarker != null) {
                             currentLocMarker.setMap(null);
                         }
                         var CurrentPosition = results[0].geometry.location;
                         currentLocMarker = new google.maps.Marker({
                             position: CurrentPosition,
                             map: map,
                             icon: '/images/ambunance1.png',
                             title: "目前位置"
                         });

                         //////////////Reset/////////////////////////////////////
                         if (lastShowMarker != null) {
                             lastinfowindow.close(map, lastShowMarker);
                             lastShowMarker.setAnimation(null);
                             lastShowMarker = null;
                             lastinfowindow = null;
                         }

                         document.getElementById("warnings_panel").innerHTML = "";
                         document.getElementById("test").innerHTML = "";
                         Debug = ""

                         //hospResp = [];

                         for (index = 0; index < hospMarker.length; index++) {
                             document.getElementById("Button" + index).style.display = "none";
                             document.getElementById("Button" + index).style.backgroundColor = "#7FFF00";
                         }
                         document.getElementById("suggesttext").style.display = "none";
                         //document.getElementById("abouttext").style.display = "none";


                         /////////////////////////////////////////////////////////
                         candlist = [];
                         hospDist = [];
                         selectCandicateHosptial(CurrentPosition);

                         //bestdist = [10000, 10000, 10000];
                         //bestidx=
                         best1dist = 10000;
                         hospDist = [];
                         calcRoute(CurrentPosition);

                     } else {
                         alert("Geocode was not successful for the following reason: " + status);
                     }
                 });
              }
         }

         function showLocation(lat, lon) {
             //document.getElementById("test").innerHTML = "0";
             if (geocoder) {
                 geocoder.geocode({ 'location': { "lat": lat, "lng": lon} }, function (results, status) {
                     if (status == google.maps.GeocoderStatus.OK) {
                         //document.getElementById("test").innerHTML = "1";
                         map.setCenter(results[0].geometry.location);
                         map.setZoom(10);
                         //map.panTo(results[0].geometry.location);

                         /*var marker = new google.maps.Marker({
                         map: map,
                         position: results[0].geometry.location
                         });*/

                         if (currentLocMarker != null) {
                             currentLocMarker.setMap(null);
                         }
                         var CurrentPosition = results[0].geometry.location;
                         currentLocMarker = new google.maps.Marker({
                             position: CurrentPosition,
                             map: map,
                             icon: '/images/ambunance1.png',
                             title: "目前位置"
                         });

                         //////////////Reset/////////////////////////////////////
                         if (lastShowMarker != null) {
                             lastinfowindow.close(map, lastShowMarker);
                             lastShowMarker.setAnimation(null);
                             lastShowMarker = null;
                             lastinfowindow = null;
                         }

                         document.getElementById("warnings_panel").innerHTML = "";
                         document.getElementById("test").innerHTML = "";
                         Debug = ""

                         //hospResp = [];

                         for (index = 0; index < hospMarker.length; index++) {
                             document.getElementById("Button" + index).style.display = "none";
                             document.getElementById("Button" + index).style.backgroundColor = "#7FFF00";
                         }
                         document.getElementById("suggesttext").style.display = "none";
                         //document.getElementById("abouttext").style.display = "none";


                         /////////////////////////////////////////////////////////
                         candlist = [];
                         hospDist = [];
                         selectCandicateHosptial(CurrentPosition);

                         //bestdist = [10000, 10000, 10000];
                         //bestidx=
                         best1dist = 10000;
                         hospDist = [];
                         calcRoute(CurrentPosition);

                     } else {
                         alert("Geocode was not successful for the following reason: " + status);
                     }
                 });
             }
         }

         function selectCandicateHosptial(CurrentPosition) {



            for (var i = 0; i < hospMarker.length; i++) {
                var branch = hospMarker[i].getPosition();
                var distance = distHaversine(branch, CurrentPosition);
                //var distance = CurrentPosition.distanceFrom(branch);
                hospDist.push({ name: i, val: distance });

            }
            //依距離進行排序
            hospDist.sort(function (a, b) {
                return a.val - b.val;
            });
            //var teststr = "";
            for (i = 0; i < 6; i++) {
                candlist[i] = hospDist[i].name;
                //teststr += candlist[i] + ":" + hospMarker[candlist[i]].title+" ";
            }

            //Debug = "";

            //Debug += hID + ":(" + candlist[hID] + " " + distance + ") ";


         }

         //計算兩個經緯座標間的距離(Haversine公式)
         function distHaversine(p1, p2) {
             var rad = function (x) { return x * Math.PI / 180; }
             var R = 6371; // earth's mean radius in km
             var dLat = rad(p2.lat() - p1.lat());
             var dLong = rad(p2.lng() - p1.lng());

             var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(rad(p1.lat())) * Math.cos(rad(p2.lat()))
                        * Math.sin(dLong / 2) * Math.sin(dLong / 2);
             var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
             var d = R * c;

             return parseFloat(d.toFixed(3));
         }



         //var hospResp = [];
         function calcRoute(start) {



             hospitalroute(start, 0);



        }

        var bestresponse;

        function hospitalroute(start, hID) {
            var cID = candlist[hID];
            var end = hospMarker[cID].getPosition();

            var request = {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING
            };


            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {

                    var myRoute = response.routes[0].legs[0];
                    var duration = myRoute.duration.value;
                    var distance = myRoute.distance.value;
                    var end_location = myRoute.end_location;
                    distance = distance / 1000.0;
                    //var teststr = "Begin ";
                    //var difference = 0.0000001;

                    if (best1dist > distance) {
                        best1dist = distance;
                        bestresponse = response;
                        var arriveTime = new Date(Date.now() + duration * 1000);
                        document.getElementById("warnings_panel").innerHTML = hospMarker[cID].title + '    行駛距離：' + distance + ' km  預估行駛時間：' + (duration / 60).toFixed(1) + '分鐘  預估到院時間：' + arriveTime.toLocaleTimeString();

                    }
                    hospDist.push({ name: cID, val: distance });

                    //hospResp[hID] = response;
                    if (hID + 1 < candlist.length) {

                        hospitalroute(start, hID + 1);
                    } else {
                        sortandShowdists();

                    }



                } else {
                    Debug += hID + " " + hospMarker[cID].title + ":" + status;

                }

            });


        }

        function sortandShowdists() {
            //var results = "B: ";
            /*for (var index = 0; index < hospDist.length; index++) {
                results += hospDist[index].val + " ";
            }*/
            var index;
            var bounds = new google.maps.LatLngBounds();
            hospDist.sort(function (a, b) {
                return a.val - b.val;
            });
            for (index = 0; index < 3; index++) {
                //results += hospDist[index].name + " ";
                //infowindow[hospDist[index]].open(map, hospMarker[hospDist[index]]);
                //document.getElementById("Button" + index).onclick = showselect("'infowindow'" + hospDist[index].name);
                //document.getElementById("Button" + hospDist[index].name).innerHTML = hospMarker[hospDist[index].name].title;
                document.getElementById("Button" + hospDist[index].name).style.display = "inline";
                bounds.extend(hospMarker[hospDist[index].name].getPosition());

            }
            document.getElementById("suggesttext").style.display = "inline";

            for (index = 0; index < hospMarker.length; index++) {
                document.getElementById("Button" + index).style.backgroundColor = "#FFFFFF";
            }
            document.getElementById("Button" + hospDist[0].name).style.backgroundColor = "#7FFF00";

            directionsDisplay.setDirections(bestresponse);
            //if (lastShowMarker != null) {
            //    lastinfowindow.close(map, lastShowMarker);
            //}
            showMarkerInfo(infowindow[hospDist[0].name], hospMarker[hospDist[0].name]);

            document.getElementById("test").innerHTML = Debug;

            //hospMarker[hospDist[index].name].setAnimation(google.maps.Animation.BOUNCE);
            //lastShowMarker = hospMarker[hospDist[index].name];

            //map.fitBounds(bounds);
            //map.setCenter(bounds.getCenter());
            //map.fitBounds(bounds);
            //directionsDisplay.setDirections(bestresponse);
            //document.getElementById("test").innerHTML = bounds.toString();
        }




         function showinfoButtonclick(infowindowShow, MarkertoShow,e) {
             showMarkerInfo(infowindowShow, MarkertoShow);
             showRoute(MarkertoShow);
             for (var index = 0; index < hospMarker.length; index++) {
                 document.getElementById("Button" + index).style.backgroundColor = "#FFFFFF";
             }
             e.target.style.backgroundColor = "#7FFF00";
         }

         function showselect(idShow) {
             document.getElementById("warnings_panel").innerHTML = "TT:" + idShow;
         }



         function showMarkerInfo(infowindowShow, MarkertoShow) {
             if (lastShowMarker != null) {
                 lastinfowindow.close(map, lastShowMarker);
                 lastShowMarker.setAnimation(null);
             }
             lastinfowindow = infowindowShow;
             lastShowMarker = MarkertoShow;
             lastinfowindow.open(map, lastShowMarker);
             lastShowMarker.setAnimation(google.maps.Animation.BOUNCE);
         }



         function showRoute(Markerdest) {


             if (currentLocMarker != null) {
                 var bounds = new google.maps.LatLngBounds();
                 bounds.extend(currentLocMarker.getPosition());
                 bounds.extend(Markerdest.getPosition());

                 var request = {
                     origin: currentLocMarker.getPosition(),
                     destination: Markerdest.getPosition(),
                     travelMode: google.maps.TravelMode.DRIVING
                 };

                 directionsService.route(request, function (response, status) {
                     if (status == google.maps.DirectionsStatus.OK) {
                         var myRoute = response.routes[0].legs[0];
                         var duration = myRoute.duration.value;
                         var distance = myRoute.distance.value;
                         distance = distance / 1000.0;
                         directionsDisplay.setDirections(response);
                         var arriveTime = new Date(Date.now() + duration * 1000);
                         document.getElementById("warnings_panel").innerHTML = Markerdest.title+'  行駛距離：' + distance + ' km  預估行駛時間：' + (duration / 60).toFixed(1) + '分鐘  預估到院時間：' + arriveTime.toLocaleTimeString();
                         //directionsDisplay.setDirections(response);

                     }

                 });
                 for (index = 0; index < hospMarker.length; index++) {
                     document.getElementById("Button" + index).style.backgroundColor = "#FFFFFF";
                 }
             }
         }



         function getLocation() {
         //document.getElementById("test").innerHTML ="there!!"
             if (navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(showPosition);
                 //navigator.geolocation.getCurrentPosition(showAddress);
             } else {
                 document.getElementById("test").innerHTML = "Geolocation is not supported by this browser.";
             }
         }

         function showPosition(position) {

             showLocation(position.coords.latitude, position.coords.longitude);

         }


        </script>
    </section>
}